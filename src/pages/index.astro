---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <h1>Mis Notass</h1>

  <form id="noteForm">
    <input type="text" name="note" placeholder="Escribe una nota..." required />
    <button type="submit">Añadir</button>
  </form>

  <ul id="notesList"></ul>

  <button id="logoutBtn">Cerrar sesión</button>

  <script>
    import { createClient } from '@supabase/supabase-js';
    
    // Crear cliente Supabase directamente aquí
    const supabase = createClient(
      'https://puwbmsavutwyeeryaskd.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1d2Jtc2F2dXR3eWVlcnlhc2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTgyNTYsImV4cCI6MjA3MDU5NDI1Nn0.ds3Pv-SnxNOrXQfOIFtZ_1I_n5un443VoKt-aIMBroY'
    );

    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = '/login';
      } else {
        fetchNotes(session.user.id);
      }
    }

    async function fetchNotes(userId: string) {
      const { data, error } = await supabase
        .from('notes')
        .select('content')
        .eq('user_id', userId);

      if (error) {
        console.error(error);
        return;
      }

      renderNotes(data || []);
    }

    function renderNotes(notes: any[]) {
      const list = document.getElementById('notesList');
      if (!list) return;
      
      list.innerHTML = '';
      notes.forEach((note: any) => {
        const li = document.createElement('li');
        li.textContent = note.content;
        list.appendChild(li);
      });
    }

    // Añadir nota
    document.getElementById('noteForm')?.addEventListener('submit', async (event) => {
      event.preventDefault();
      const target = event.target as HTMLFormElement;
      const noteInput = target.querySelector('[name="note"]') as HTMLInputElement;
      if (!noteInput) return;
      
      const content = noteInput.value;

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const { error } = await supabase
        .from('notes')
        .insert({ user_id: session.user.id, content });

      if (error) {
        console.error(error);
      } else {
        noteInput.value = '';
        fetchNotes(session.user.id);
      }
    });

    // Logout
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/login';
    });

    checkAuth();
  </script>
</Layout>